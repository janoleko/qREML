---
title: "Marginal maximum likelihood estimation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Visualization why marginal maximum likelihood estimation works

Here we assume the remaining parameters are fixed and we only have a one dimensional random effect with a normal distribution as prior. We can then visualize the conditional likelihood function and the prior distribution. The product of both is the joint likelihood function. 

```{r }
par(mfrow = c(1,1))
curve(dnorm(x, mean = 5, sd = 1), xlim = c(-5,10), n = 500, lwd = 2, 
      xlab = "b", ylab = "likelihood", ylim = c(0, 0.5), bty = "n")
curve(dnorm(x, mean = 0, sd = sqrt(1/0.25)), add = TRUE, col = "orange", lwd = 2, n = 500)
curve(dnorm(x, mean = 5, sd = 1) * 
        dnorm(x, mean = 0, sd = sqrt(1/0.25)), col = "deepskyblue", lwd = 2, n = 500, add = TRUE)

legend("topright", legend = c("f(x|b)", "f(b)", "f(x|b) f(b)"), col = c("black", "orange", "deepskyblue"), lwd = 2, bty = "n")
```

As we cannot see much, I rescale the y-axis and only show the product:

```{r }
curve(dnorm(x, mean = 5, sd = 1) * 
        dnorm(x, mean = 0, sd = 2), xlim = c(-5,10), ylim = c(0, 0.01),
      col = "deepskyblue", lwd = 2, n = 500, xlab = "b", ylab = "density", bty = "n")
legend("topright", legend = c("f(x,b) = f(x|b) f(b)"), col = "deepskyblue", lwd = 2, bty = "n")

```

Now we can easily visualize the effect of varying penalty strengths that are inverse to the variance of the prior distribution:

```{r }
par(mfrow = c(1,5))
lambda = c(0.5, 0.25, 0.1, 0.001, 0.0001)

for(j in 1:5){
  curve(dnorm(x, mean = 5, sd = 1) * 
          dnorm(x, mean = 0, sd = sqrt(1/lambda[j])), xlim = c(-5,10), ylim = c(0, 0.02),
        col = "deepskyblue", lwd = 2, n = 500, xlab = "b", ylab = "density", bty = "n", main = paste("lambda =", lambda[j]))
  legend("topright", legend = "f(x|b) f(b)", col = "deepskyblue", lwd = 2, bty = "n")
}
```

Now its easy to see, that a medium penalty indeed yields the largest integral, but we can also calculate the integrals:

```{r }
I = rep(NA, 5)
for(j in 1:5){
  I[j] = integrate(function(x) dnorm(x, mean = 5, sd = 1) * 
                     dnorm(x, mean = 0, sd = sqrt(1/lambda[j])), -Inf, Inf)$value
}

par(mfrow = c(1,1))
plot(I, pch = 19, lwd = 2, xlab = "lambda", ylab = "integrated likelihood", bty = "n")
```